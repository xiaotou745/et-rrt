<%@ page language="java" contentType="text/html; charset=utf-8"
	pageEncoding="utf-8"%>
<%@page import="com.renrentui.renrenentity.common.PagedResponse"%>
<%@page import="com.renrentui.renrencore.util.PageHelper"%>
<%@page import="java.util.ArrayList"%>
<%@page import="com.renrentui.renrenentity.Business"%>
<%@page import="java.util.List"%>
<%@page import="com.renrentui.renrencore.util.PropertyUtils"%>

<%
	String basePath =PropertyUtils.getProperty("java.admin.url");
%>

<table
	class="table table-striped table-bordered table-hover dataTables-example">
	<thead>
		<tr class="tdbg">
			<th width="%5">编号</th>
			<th width="10%">公司名称</th>
		</tr>
	</thead>

	<tbody>

		<%
			PagedResponse<Business> responsePageList = (PagedResponse<Business>)request.getAttribute("listData");
			List<Business> data=responsePageList.getResultList();
			for (int i = 0; i < data.size(); i++) {			
		%>
		<tr>
			<td><%=data.get(i).getId()%></td>
			<td><%=data.get(i).getCompanyName()%></td>			
		</tr>
		<%
			}
		%>

	</tbody>
</table>
<%=PageHelper.getPage(responsePageList.getPageSize(),
		responsePageList.getCurrentPage(), responsePageList.getTotalRecord(),
		responsePageList.getTotalPage())%>
<script type="text/javascript">
    function businessCancel(businessId)
    {
    	if (!window.confirm("是否取消审核？")) {
            return;
        }
        var paramaters = { "businessID": businessId,"status":4 };
        var url = "<%=basePath%>/business/audit";
        $.ajax({
            type: 'POST',
            url: url,
            data: paramaters,
            success: function (result) {
            	if (result>0) {
                    window.location.href = "<%=basePath%>/business/list";
                } else {
                    alert("操作失败");
                }
            }
        });
    }
    ///操作审核验证
    function businessOk(checkAddress, businessId, Proportion, checkImage, commissionType, Latitude, Longitude) {
        if (!window.confirm("是否审核通过？")) {
            return;
        }
        if (checkAddress == 0) {
            alert("该商家未填写配送地址，不能通过审核。")
            return;
        }
        if (Proportion < 10 && commissionType == 1) {
            alert("该商家结算比例小于10%，不能通过审核。")
            return;
        }
        if (checkImage == 0) {
            alert("该商家未上传图片，不能通过审核。")
            return;
        }
        //debugger
        var lng = parseFloat(Longitude);
        var lat = parseFloat(Latitude);
        if (lng<73.40||lng>135.230||lat<3.52||lat>53.33) {
            alert("该商家地址有误，不能通过审核。")
            return;
        }
        var paramaters = { "businessID": businessId,"status":1 };
        var url = "<%=basePath%>/business/audit";
        $.ajax({
            type: 'POST',
            url: url,
            data: paramaters,
            success: function (result) {
                if (result>0) {
                    window.location.href = "<%=basePath%>/business/list";
                } else {
                    alert("操作失败");
                }
            }
        });
    }
    
    
    //商户充值
    function businessRecharge(id, name, phone) {
        $('#busId').val(0);
        $('#busName').val('');
        $('#busPhone').val('');
        $('#busRechargeAmount').val('');
        $('#rechargeLog').val('');
        $('#busId').val(id);
        $('#busName').val(name);
        $('#busPhone').val(phone);
        $('#BusinessRechargeShow').modal('show');
    }
  //商户充值
    $("#btnRechargeCommit").on('click', function () {
        var busiId = $("#busId").val(); //商户id
        var busiName = $("#busName").val(); //商户电话
        var busRechargeType = $('#RechargeType').val();//充值类型
        var busiRechargeAmount = $("#busRechargeAmount").val(); //商户充值金额
        var busiRechargeAmountFree = $("#busRechargeAmountFree").val(); //商户赠送金额
        var rechargeLog = $("#rechargeLog").val(); //充值描述
        if (rechargeLog.trim().length == 0) {
            alert("请输入充值操作描述!");
            return;
        }
        var decimalFormat = /^[0-9]*(\.[0-9]{1,2})?$/;
        if ((busRechargeType == '1' || busRechargeType == '3') && !decimalFormat.test(busiRechargeAmount)) {
            alert("请输入正确的充值金额！");
            return;
        }
        if ((busRechargeType == '1' || busRechargeType == '3') && (busiRechargeAmount < 1 || busiRechargeAmount > 50000)) {
            alert("充值金额须在1-50000元之间！");
            return;
        }
        if ((busRechargeType == '2' || busRechargeType == '3') && !decimalFormat.test(busiRechargeAmountFree)) {
            alert("请输入正确的赠送金额！");
            return;
        }
        if ((busRechargeType == '2' || busRechargeType == '3') && (busiRechargeAmountFree < 1 || busiRechargeAmountFree > 50000)) {
            alert("赠送金额须在1-50000元之间！");
            return;
        }
        var tipstr = "";
        switch (busRechargeType) {
            case "1":
                tipstr = "确定要为商户：" + busiName + "  充值：" + busiRechargeAmount + "元？"; break;
            case "2":
                tipstr = "确定要为商户：" + busiName + "  赠送：" + busiRechargeAmountFree + "元？"; break;
            case "3":
                tipstr = "确定要为商户：" + busiName + "  充值：" + busiRechargeAmount + " 元,赠送:" + busiRechargeAmountFree + "元？"; break;

        }
        if (confirm(tipstr)) {
            var paramaters = {
                "businessId": busiId,
                "rechargeAmount": busiRechargeAmount,
                "remark": rechargeLog,
                "rechargeAmountFree": busiRechargeAmountFree,
                "rechargeType": busRechargeType
            };
            var url = "<%=basePath%>/business/recharge";
            $.ajax({
                type: 'POST',
                url: url,
                data: paramaters,
                success: function (result) {
                    if (result.IsSuccess) {
                        alert(result.Message);
                        window.location.href = "<%=basePath%>/business/list";
                    } else {
                        alert(result.Message);
                    }
                }
            });
        }
    });
    function businessWithdraw(busiId, name, phone) { 
        var paramaters = {
            "businessID": busiId
        };
        $.ajax({
            type: 'POST',
            async:true,
            url: '<%=basePath%>/business/getfinanceaccount',
            data: paramaters,
            success: function (bfa) {
                if (bfa != null&&bfa!="") {
                    $("#openProvince").val(bfa.openProvince);
                    $("#openProvinceCode").val(bfa.openProvinceCode);
                    $("#openCity").val(bfa.openCity);
                    $("#openCityCode").val(bfa.openCityCode);
                    $("#idCard").val(bfa.idcard);
                    if (bfa.belongtype == 0) {
                        $("#accountType").val('个人账户');
                    } else if (bfa.belongtype == 1) {
                        $("#accountType").val('公司账户');
                    } else {
                        $("#accountType").val('未知');
                    }
                }
                ClearFinanceAccount(busiId, name, phone);
            }
        });
    }
    function ClearFinanceAccount(busiId, name, phone) {
        $('#withdrawId').val(0);
        $('#withdrawName').val('');
        $('#withdrawPhone').val('');
        $('#withdrawAmount').val('');
        $('#withdrawLog').val('');
        $('#withdrawId').val(busiId);
        $('#withdrawName').val(name);
        $('#withdrawPhone').val(phone);
        $('#BusinessWithdraw').modal('show');
    }
  //商户提现
    $("#btnWithdrawCommit").on('click', function () {
        var withdrawId = $("#withdrawId").val(); //商户id
        var busiName = $("#withdrawPhone").val(); //商户电话
        var withdrawAmount = $("#withdrawAmount").val();
        var withdrawLog = $("#withdrawLog").val();
        var selectProvinceName = $("#openProvince").val();
        var selectProvinceCode = $("#openProvinceCode").val();
        var selectCityName = $("#openCity").val();
        var selectCityCode = $("#openCityCode").val();
        var idCard = $("#idCard").val();
		if(idCard==""){
		    alert("身份证号/营业执照为空，不能提现！");
		    return;
		} 
        var decimalFormat = /^[0-9]*(\.[0-9]{1,2})?$/;
        if (!decimalFormat.test(withdrawAmount)) {
            alert("请输入正确的金额！");
            return;
        }
        if (withdrawAmount < 1 || withdrawAmount > 1000000) {
            alert("请输入正确的提款金额，大于1元小于1,000,000！");
            return;
        }

        if (confirm("是否确认提款?")) {
            var paramaters = {
                "BusinessId": withdrawId,
                "WithdrawPrice": withdrawAmount,
                "Remarks": withdrawLog,
                "OpenProvinceCode": selectProvinceCode,
                "OpenProvince": selectProvinceName,
                "selectCityCode": selectCityCode,
                "OpenCity": selectCityName,
                "idCard": idCard
            };
            var url = "<%=basePath%>/business/withdraw";
            $.ajax({
                type: 'POST',
                url: url,
                data: paramaters,
                success: function (result) {

                    if (result.Status == "1") {
                        alert(result.Message);
                        window.location.href = "<%=basePath%>/business/list";
                    } else {
                        alert(result.Message);
                    }
                }
            });
        }
    });
</script>


