<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.renrentui.renrenapi.dao.inter.IRenRenTaskDao" >
  <sql id="Base_Column_List" >
    Id, TaskTitle, TaskGeneralInfo, BusinessId, Pusher, CreateName, CreateTime, 
    ModifyName, ModifyTime, BeginTime, EndTime,  Amount, status, 
      PaymentMethod,AuditCycle,TargetPeople,TaskType,HotLine,DownUrl,ScanTip,Reminder
  </sql>
  <select id="selectById" resultType="com.renrentui.renrenentity.RenRenTask" parameterType="java.lang.Long" >
    select 
    <include refid="Base_Column_List" />
    from RenRenTask (NOLOCK)
    where Id = #{id,jdbcType=BIGINT}
  </select>
  <!--添加一个任务 茹化肖 2015年11月16日13:45:54 -->
  <insert id="insert" parameterType="com.renrentui.renrenentity.RenRenTask" >
    	  <selectKey resultType="java.lang.Long" keyProperty="id"
				order="AFTER">
				select @@IDENTITY as id
	  </selectKey>
    insert into RenRenTask (
	  TaskTitle,
      TaskGeneralInfo,
      BusinessId, 
      Pusher, 
      CreateName, 
      CreateTime,
      ModifyName, 
      ModifyTime, 
      BeginTime,
      EndTime, 
      Amount, 
      status, 
      AuditCycle,
      HotLine,
      TaskType,
      DownUrl,
      ScanTip,
      Reminder)
    values (
      #{taskTitle,jdbcType=NVARCHAR},
      #{taskGeneralInfo,jdbcType=NVARCHAR},
      #{businessId,jdbcType=BIGINT}, 
      #{pusher,jdbcType=NVARCHAR}, 
      #{createName,jdbcType=NVARCHAR},
       getdate(),
       #{modifyName,jdbcType=NVARCHAR},
        getdate(),
      #{beginTime},
       #{endTime}, 
      #{amount,jdbcType=DECIMAL}, 
      #{status,jdbcType=INTEGER},
      #{auditCycle,jdbcType=BIGINT}, 
      #{hotLine,jdbcType=NVARCHAR},
       #{taskType,jdbcType=INTEGER},
       #{downUrl,jdbcType=NVARCHAR},
       #{scanTip,jdbcType=NVARCHAR},
       #{reminder,jdbcType=NVARCHAR})
  </insert>
  <!-- 获取任务详情接口  2015年11月19日11:24:46 V1.0.2 茹化肖  -->
   <select id="getTaskDetail" resultType="com.renrentui.renrenentity.RenRenTask" parameterType="com.renrentui.renrenentity.req.TaskDatumDetailReq" >
SELECT TOP 1  rrt.id,
        b.Logo ,
        rrt.amount,
        rrt.TaskTitle ,
        rrt.TaskType ,
        rrt.TaskGeneralInfo ,
        AuditCycle ,
        EndTime ,
        HotLine,
        CASE WHEN ct.id is NULL THEN 0 ELSE 1 END AS IsHad,
        ISNULL(ct.id,0) AS CtId,
        rrt.pusher,
        rrt.DownUrl,
        rrt.ScanTip,
        rrt.Reminder,
        rrt.status
FROM    dbo.RenRenTask AS rrt ( NOLOCK )
        JOIN dbo.Business AS b ( NOLOCK ) ON rrt.BusinessId = b.id
        LEFT JOIN dbo.ClienterTask AS ct ON ct.TaskId=rrt.id AND ct.ClienterId=${userId}
WHERE   rrt.id =  ${taskId}
  </select>
  <!-- 验证任务是否可以领取 2015年9月29日17:13:19 茹化肖 v1.0.2 -->
 <select id="checkTask" resultType="com.renrentui.renrenentity.domain.CheckTask" parameterType="com.renrentui.renrenentity.req.TaskDatumDetailReq" >
SELECT  BusinessId ,
        Amount ,
        TaskType
FROM    dbo.RenRenTask AS rrt(NOLOCK)
WHERE   EndTime > GETDATE()
        AND rrt.Status = 1
        AND rrt.id = ${taskId}
  </select>

  
    	<!-- 获取任务列表 WHERE茹化肖 2015年11月24日13:51:51 -->
  <sql id="getPagedRenRenTaskListWhere">
		1=1		
		<if test="createTimeBegin != null and createTimeBegin!=''">
			and createTime >=''${createTimeBegin}''
		</if>
		<if test="createTimeEnd != null and createTimeEnd!=''">
			and ''${createTimeEnd} 23:59:59''>createTime
		</if>
	    <if test="beginTime != null and beginTime!=''">
			and (beginTime>''${beginTime}'' or ''${beginTime}'' >endTime)
		</if>
		<if test="endTime != null and endTime != ''">
			and (''${endTime} 23:59:59''>=endTime or ''${endTime} 23:59:59''>=beginTime)
		</if>
<!-- 		<if test="beginTime != null and beginTime!='' and endTime != null and endTime != ''"> -->
<!-- 			and -->
<!-- 			(  -->
<!-- 			(beginTime>''${beginTime}'' and ''${endTime} 23:59:59''>=beginTime)  -->
<!-- 			or -->
<!-- 			(endTime>''${beginTime}'' and ''${endTime} 23:59:59''>=endTime) -->
<!-- 			) -->
<!-- 		</if> -->
	    <if test="status != null and status>-1">
			and status=${status}
		</if>
		<if test="taskType != null and taskType>0">
			and taskType=${taskType}
		</if>
		<if test="taskTitle != null and taskTitle!=''">
			and taskTitle like ''%${taskTitle}%''
		</if>	
		<if test="pusher != null and pusher!=''">
			and pusher like ''%${pusher}%''
		</if>	
	</sql>
  	<!-- 获取任务列表 茹化肖 2015年11月24日13:51:51 -->
  	<select id="getPagedRenRenTaskList" resultType="com.renrentui.renrenentity.domain.RenRenTaskModel"
		parameterType="com.renrentui.renrenentity.req.PagedRenRenTaskReq"
		statementType="CALLABLE">
		{call Sp_CustomPage2015_V1(
		' rrt.Id DESC ',
		'id ,
        TaskTitle ,
        CreateName ,
        CreateTime ,
        BeginTime ,
        EndTime ,
        Pusher ,
        Amount ,
        Status ,
        TaskType
        ',
		' dbo.RenRenTask AS rrt (NOLOCK)  
        ',
		'
		<include refid="getPagedRenRenTaskListWhere" />
		',
		#{pageSize,mode=IN,jdbcType=INTEGER},
		#{currentPage,mode=IN,jdbcType=INTEGER}
		,1,
		#{totalRecord,mode=OUT,jdbcType=INTEGER},
		#{totalPage,mode=OUT,jdbcType=INTEGER}
		)}
	</select>
	  <update id="setTaskStatus" parameterType="com.renrentui.renrenentity.req.UpdateStatusReq" >
	UPDATE dbo.RenRenTask 
	<set >
      <if test="status != null" >
       status=#{status,jdbcType=BIGINT},
      </if>
      <if test="userName != null and userName!=''" >
       modifyName=#{userName,jdbcType=NVARCHAR},modifyTime=getdate(),
      </if>
    </set>
     where Id = #{reocrdId,jdbcType=BIGINT} and status=#{oldStatus,jdbcType=BIGINT}
  </update>
<select id="getNewTaskList" resultType="com.renrentui.renrenentity.domain.TaskModel" parameterType="com.renrentui.renrenentity.req.TaskReq" >
select 
<if test="itemsCount != 0" >
	top  ${itemsCount} 
</if>
  a.Id as taskId ,
        a.taskGeneralInfo ,
        a.taskTitle as taskName ,
        a.tasktype,
        a.amount,
        m.logo
  FROM      RenRenTask a WITH(nolock)
            JOIN TaskCityRelation b WITH(nolock) ON a.Id = b.TaskId
            JOIN dbo.Business m WITH(NOLOCK) ON a.BusinessId=m.id
            <if test="userId != 0" >
            LEFT JOIN ClienterTask c WITH(nolock) ON a.id = c.TaskId and c.ClienterId =  ${userId}
  			</if> 
  WHERE     a.Status = 1
  			and getdate()>=a.BeginTime and a.EndTime>getdate()  
            AND (b.CityCode = ${cityCode} or b.CityCode =${provinceCode} or b.CityCode=-1)
		    <if test="userId != 0" >
		   	   AND c.id IS NULL
		   	</if> 
			 <if test="nextId != 0" >
		         and ${nextId} > a.Id
		     </if>
   order by a.Id desc;
  </select>   
  
   <select id="getNewTaskListTotal" resultType="java.lang.Integer" parameterType="com.renrentui.renrenentity.req.TaskReq" >
   	select count(1) 
   	FROM      RenRenTask a WITH(nolock)
            JOIN TaskCityRelation b WITH(nolock) ON a.Id = b.TaskId
            JOIN dbo.Business m WITH(NOLOCK) ON a.BusinessId=m.id
            <if test="userId != 0" >
            LEFT JOIN ClienterTask c WITH(nolock) ON a.id = c.TaskId and c.ClienterId =  ${userId}
  			</if> 
  WHERE     a.Status = 1
  			and getdate()>=a.BeginTime and a.EndTime>getdate()  
            AND (b.CityCode = ${cityCode} or b.CityCode=-1)
		    <if test="userId != 0" >
		   	   AND c.id IS NULL
		   	</if> 
  </select> 
  <!--  我的任务  已领取 -->
  <select id="getMyReceivedTaskList" resultType="com.renrentui.renrenentity.domain.MyReceiveTask" 
  parameterType="com.renrentui.renrenentity.req.TaskReq" >
	select 
	<if test="itemsCount != 0" >
		top  ${itemsCount} 
	</if>
 rrt.ID AS TaskId,
 rrt.TaskGeneralInfo,
 rrt.TaskTitle AS taskName,
 rrt.TaskType,
 rrt.Amount,
 rrt.DownUrl,
 rrt.ScanTip,
 rrt.Reminder,
 b.Logo,
 ct.CompleteNum,
 ct.id as CtId,
 CTD.auditWaitNum,
 CTD.auditPassNum,
 CTD.auditRefuseNum
FROM dbo.ClienterTask AS ct  (NOLOCK)
INNER JOIN dbo.RenRenTask AS rrt(NOLOCK) ON ct.TaskId=rrt.id
INNER JOIN dbo.Business AS b (NOLOCK) ON rrt.BusinessId=b.id
LEFT JOIN (SELECT  CtId ,
SUM(CASE [Status] WHEN 1 THEN 1 ELSE 0 END) AS auditWaitNum,
SUM(CASE [Status] WHEN 2 THEN 1 ELSE 0 END) AS auditPassNum,
SUM(CASE [Status] WHEN 3 THEN 1 ELSE 0 END) AS auditRefuseNum
                    FROM    TaskDatum AS TD( NOLOCK )
                    WHERE   ClienterId = ${userId} 
                    GROUP BY CtId) AS CTD ON ctd.CtId=ct.id 
WHERE ct.ClienterId= ${userId} 
<if test="taskStatus == 3" >
	and  rrt.status in (3,4)
</if>
<if test="taskStatus == 1" >
	and  rrt.status =1
</if> 
<if test="nextId != 0" >
	and   ${nextId}>rrt.id
</if>
	order by rrt.Id desc;
</select>   
    <!--  我的任务  已领取表头数量 -->
   <select id="getMyReceivedTaskListTotal" resultType="com.renrentui.renrenentity.domain.ReceiveNum" parameterType="com.renrentui.renrenentity.req.TaskReq" >
   SELECT  SUM(CASE WHEN rrt.Status = 1 THEN 1
                 ELSE 0
            END) AS passTotal ,
        SUM(CASE WHEN rrt.Status != 1 THEN 1
                 ELSE 0
            END) AS refuseTotal
FROM    dbo.ClienterTask AS ct ( NOLOCK )
        JOIN dbo.RenRenTask AS rrt ( NOLOCK ) ON ct.ClienterId = ${userId}
                                                 AND ct.TaskId = rrt.id
  </select> 
  <!-- 我的任务  审核中  未通过 -->
   <select id="getSubmittedTaskList" resultType="com.renrentui.renrenentity.domain.TaskModel" parameterType="com.renrentui.renrenentity.req.TaskReq" >
   
   	select 
   	<if test="itemsCount != 0" >
   		top  ${itemsCount} 
   	</if> 
       rt.Id TaskId ,
                rt.TaskGeneralInfo ,
                rt.Pusher ,
                rt.TaskTitle TaskName ,
                rt.Amount ,
                case  when o.OrderStatus is null then -1 else o.OrderStatus end [Status], o.AuditStatus ,
                isnull(rt.BeginTime,'') BeginTime,
                isnull(rt.EndTime,'') EndTime,
                rt.PaymentMethod ,
                isnull(o.CreateTime,'') ReceivedTime ,
                isnull(o.FinishTime,'') FinishTime,
                o.Id myReceivedTaskId,
                o.Id orderId,isnull(o.AuditTime,'') AuditTime,
                o.CancelTime,
                o.DealLineTime,
                b.logo,
                (case when rt.EndTime>getdate()  and rt.Status=1 and rt.Id not in (
					 select TaskId from dbo.[Order](nolock) where ClienterId=${userId} and OrderStatus=0
                ) then 1 else 0 end) IsAgainPickUp,
                (SELECT count(1) FROM dbo.[Order] oo(nolock) where oo.TaskId = rt.id
and oo.AuditStatus = 0 AND oo.OrderStatus=1) WaitAuditCount 
from    dbo.[Order] o join dbo.RenRenTask rt on rt.Id = o.TaskId  and o.ClienterId = ${userId}
		join dbo.Business b (nolock) on rt.BusinessId = b.Id 
where  1=1 
      <if test="orderStatus != null" >
       and   o.orderStatus = #{orderStatus,jdbcType=SMALLINT}
      </if>
     <if test="auditStatus != null" >
        and  auditStatus = #{auditStatus,jdbcType=SMALLINT}
      </if>
	  <if test="nextId != 0" >
         and o.Id > ${nextId}
     </if>
order by o.Id asc;
  </select>   
    <!-- 我的任务  审核中  未通过 -->
  <select id="getSubmittedTaskListTotal" resultType="java.lang.Integer" parameterType="com.renrentui.renrenentity.req.TaskReq" >
   	select count(1) from  dbo.[Order] o
                join dbo.RenRenTask rt on rt.Id = o.TaskId and o.ClienterId =  ${userId} where  1=1 
      <if test="orderStatus != null" >
        and  o.orderStatus = #{orderStatus,jdbcType=SMALLINT}  
      </if>
     <if test="auditStatus != null" >
       and auditStatus = #{auditStatus,jdbcType=SMALLINT}
      </if>
     <if test="nextId != 0" >
         and o.Id > ${nextId}
     </if>
  </select> 
  <!-- 超时关闭任务服务  茹化肖 -->
	<update id="outTimeCanelTask">
	      UPDATE  dbo.RenRenTask
        SET     Status = 3
        OUTPUT  inserted.Id ,
                3 ,
                '系统服务' ,
                '超时任务自动过期'
                INTO RenRenTasklog ( RenRenTaskId, OptType, OptName, Remark )
        WHERE   GETDATE()>=EndTime
                AND Status = 1
	</update>
	  <update id="update" parameterType="com.renrentui.renrenentity.RenRenTask" >
    update RenRenTask
    set TaskTitle = #{taskTitle,jdbcType=NVARCHAR},
      TaskGeneralInfo = #{taskGeneralInfo,jdbcType=NVARCHAR},
      BusinessId = #{businessId,jdbcType=BIGINT},
      Pusher = #{pusher,jdbcType=NVARCHAR},
      ModifyName = #{modifyName,jdbcType=NVARCHAR},
      ModifyTime = getdate(),
      BeginTime = #{beginTime,jdbcType=TIMESTAMP},
      EndTime = #{endTime,jdbcType=TIMESTAMP},
      Amount = #{amount,jdbcType=DECIMAL},
      Status = #{status,jdbcType=INTEGER},
      PaymentMethod = #{paymentMethod,jdbcType=SMALLINT},
      AuditCycle=#{auditCycle,jdbcType=INTEGER},
      TargetPeople = #{targetPeople,jdbcType=INTEGER}
    where Id = #{id,jdbcType=BIGINT} and (Status=0 or Status=2)
  </update>
 
  <!-- 添加任务的步骤信息 茹化肖 2015年11月16日15:30:04 -->
  <insert id="insertTaskSetp" parameterType="com.renrentui.renrenentity.domain.TaskSetp">
  INSERT INTO dbo.TaskSetp
  (TaskId,
   LinkTitle,
   SortNo,
   SetpType,
   [Content])
   values (
   ${taskId},
   '${linkTitle}',
   ${sortNo} ,
   ${setpType},
   '${content}')
  </insert>
    <!-- 添加任务的模板组信息 茹化肖 2015年11月16日15:30:04 -->
  <insert id="insertTemplateGrpup" parameterType="com.renrentui.renrenentity.domain.TemplateGroup">
  		<selectKey resultType="java.lang.Long" keyProperty="id"
				order="AFTER">
				select @@IDENTITY as id
	    </selectKey>
INSERT INTO dbo.TemplateGroup
        ( TaskId ,
          GroupType ,
          Title
        )
VALUES  ( ${taskId} , 
          ${groupType} , 
          '${title}' 
        )
  </insert>
  <!-- 参与任务 茹化肖 2015年11月19日14:40:41 -->
  <select id="insertClienterTask" parameterType="com.renrentui.renrenentity.domain.ClienterTask" resultType="java.lang.Long">
  IF NOT EXISTS (SELECT id FROM ClienterTask WHERE TaskId=${taskId} AND ClienterId=${clienterId})
	BEGIN
		INSERT INTO dbo.ClienterTask	
		        ( TaskId ,
		          ClienterId ,
		          BusinessId ,
		          Amount ,
		          TaskType
		        )
		VALUES  ( ${taskId} , 
		          ${clienterId} , 
		          ${businessId} , 
		          ${amount} , 
		          ${taskType} 
		        ); 
	SELECT @@IDENTITY
	END
ELSE
	BEGIN
	SELECT -1
	END
  
  </select>
  <!-- 提交一次资料将完成次数加1 茹化肖2015年11月20日00:16:42 -->
  <update id="addClienterCompleteCount" parameterType="java.lang.Long">
  UPDATE ClienterTask SET CompleteNum=(CompleteNum+1) WHERE id=#{ctId,jdbcType=BIGINT}
  </update>
  <!-- 修改任务删除任务下的信息 茹化肖 2015年11月26日17:01:15 -->
  <delete id="clearTaskInfo" parameterType="java.lang.Long">
DELETE dbo.TemplateDetail  WHERE TemplateGroupId IN (
SELECT Id FROM dbo.TemplateGroup (NOLOCK) WHERE TaskId=#{taskId,jdbcType=BIGINT})
DELETE dbo.TemplateGroup WHERE TaskId=#{taskId,jdbcType=BIGINT}
DELETE dbo.TaskSetp WHERE TaskId=#{taskId,jdbcType=BIGINT}
DELETE TaskCityRelation WHERE TaskId=#{taskId,jdbcType=BIGINT}
  
  </delete>
  
    <!-- 修改任务 更新任务信息 -->
  <update id="updateTaskInfo" parameterType="com.renrentui.renrenentity.RenRenTask">
  UPDATE dbo.RenRenTask	SET
      <trim suffixOverrides="," > 
      ModifyTime=getdate(),
      <if test="taskTitle != null" >
       TaskTitle=#{taskTitle,jdbcType=NVARCHAR},
      </if>
	  <if test="taskGeneralInfo != null" >
       TaskGeneralInfo=#{taskGeneralInfo,jdbcType=NVARCHAR},
      </if>
      <if test="businessId != null" >
       BusinessId=#{businessId,jdbcType=BIGINT}, 
      </if>
      <if test="pusher != null" >
      Pusher=#{pusher,jdbcType=NVARCHAR}, 
      </if>
      <if test="modifyName != null" >
      ModifyName= #{modifyName,jdbcType=NVARCHAR}, 
      </if>
 	  <if test="beginTime != null" >
      BeginTime= #{beginTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null" >
        EndTime= #{endTime,jdbcType=TIMESTAMP}, 
      </if>
      <if test="amount != null" >
           Amount=#{amount,jdbcType=DECIMAL}, 
      </if>
      <if test="status != null" >
           status=#{status,jdbcType=INTEGER}, 
      </if>
      <if test="auditCycle != null" >
          AuditCycle=#{auditCycle,jdbcType=BIGINT}, 
      </if>
      <if test="hotLine != null" >
          HotLine=#{hotLine,jdbcType=NVARCHAR}, 
      </if>
      <if test="taskType != null" >
          TaskType=#{taskType,jdbcType=INTEGER},
      </if>
      <if test="downUrl!= null" >
         DownUrl=#{downUrl,jdbcType=NVARCHAR},
      </if>
       <if test="scanTip!= null" >
          ScanTip=#{scanTip,jdbcType=NVARCHAR},
      </if>
      <if test="reminder != null" >
        Reminder=#{reminder,jdbcType=NVARCHAR},
      </if>
      </trim>
      WHERE id=#{id,jdbcType=BIGINT}
  </update>
  <!--  获取任务下面所有骑士ID -->
  <select id="getClinerIdList" parameterType="java.lang.Long" resultType="java.lang.Long">
  SELECT ClienterId FROM dbo.ClienterTask AS ct (NOLOCK) WHERE TaskId=#{taskId,jdbcType=BIGINT}
  </select>
   <!--  获取已经还有一天就过期的任务信息 -->
  <select id="getTaskSendList"  resultType="com.renrentui.renrenentity.RenRenTask">
SELECT  id ,
        TaskTitle
FROM    dbo.RenRenTask AS rrt ( NOLOCK )
WHERE   rrt.Status = 1
        AND IsSend = 0
        AND GETDATE() > DATEADD(DAY, -1, rrt.EndTime)
        AND rrt.EndTime > GETDATE()
  </select>
  <!-- 设置任务为已经发过消息 -->
  <update id="setTaskSend" parameterType="java.lang.Long">
  UPDATE dbo.RenRenTask SET IsSend=1 WHERE id =#{taskId,jdbcType=BIGINT}
  </update>
</mapper>