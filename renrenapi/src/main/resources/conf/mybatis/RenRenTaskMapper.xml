<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.renrentui.renrenapi.dao.inter.IRenRenTaskDao" >
  <sql id="Base_Column_List" >
    Id, TaskTitle, TaskNotice, TaskGeneralInfo, BusinessId, Pusher, CreateName, CreateTime, 
    ModifyName, ModifyTime, BeginTime, EndTime, TaskCycle, AvailableCount, Amount, status, 
    TaskTotalCount, SnapshotTemplateId, Link, PaymentMethod,AuditCycle,TaskNote,TargetPeople,CompanySummary,TaskType,HotLine
  </sql>
  <select id="selectById" resultType="com.renrentui.renrenentity.RenRenTask" parameterType="java.lang.Long" >
    select 
    <include refid="Base_Column_List" />
    from RenRenTask (NOLOCK)
    where Id = #{id,jdbcType=BIGINT}
  </select>
  <!--添加一个任务 茹化肖 2015年11月16日13:45:54 -->
  <insert id="insert" parameterType="com.renrentui.renrenentity.RenRenTask" >
    	  <selectKey resultType="java.lang.Long" keyProperty="id"
				order="AFTER">
				select @@IDENTITY as id
	  </selectKey>
    insert into RenRenTask (
	  TaskTitle,
      TaskGeneralInfo,
      BusinessId, 
      Pusher, 
      CreateName, 
      CreateTime,
      ModifyName, 
      ModifyTime, 
      BeginTime,
      EndTime, 
      Amount, 
      status, 
      AuditCycle,
      HotLine,
      TaskType)
    values (
      #{taskTitle,jdbcType=NVARCHAR},
      #{taskGeneralInfo,jdbcType=NVARCHAR},
      #{businessId,jdbcType=BIGINT}, 
      #{pusher,jdbcType=NVARCHAR}, 
      #{createName,jdbcType=NVARCHAR},
       getdate(),
       #{modifyName,jdbcType=NVARCHAR},
        getdate(),
      #{beginTime,jdbcType=TIMESTAMP},
       #{endTime,jdbcType=TIMESTAMP}, 
      #{amount,jdbcType=DECIMAL}, 
      #{status,jdbcType=INTEGER},
      #{auditCycle,jdbcType=BIGINT}, 
      #{hotLine,jdbcType=NVARCHAR},
       #{taskType,jdbcType=INTEGER})
  </insert>
  <!-- 获取任务详情接口  2015年11月19日11:24:46 V1.0.2 茹化肖  -->
   <select id="getTaskDetail" resultType="com.renrentui.renrenentity.RenRenTask" parameterType="com.renrentui.renrenentity.req.TaskDetailReq" >
SELECT TOP 1  rrt.id,
        b.Logo ,
        rrt.amount,
        rrt.TaskTitle ,
        rrt.TaskType ,
        rrt.TaskGeneralInfo ,
        AuditCycle ,
        EndTime ,
        HotLine,
        CASE WHEN ct.id is NULL THEN 0 ELSE 1 END AS IsHad,
        ISNULL(ct.id,0) AS CtId
FROM    dbo.RenRenTask AS rrt ( NOLOCK )
        JOIN dbo.Business AS b ( NOLOCK ) ON rrt.BusinessId = b.id
        LEFT JOIN dbo.ClienterTask AS ct ON ct.TaskId=rrt.id AND ct.ClienterId=${userId}
WHERE   rrt.id =  ${taskId}
  </select>
  <!-- 验证任务是否可以领取 2015年9月29日17:13:19 茹化肖 v1.0.2 -->
 <select id="checkTask" resultType="com.renrentui.renrenentity.domain.CheckTask" parameterType="com.renrentui.renrenentity.req.TaskDetailReq" >
SELECT  BusinessId ,
        Amount ,
        TaskType
FROM    dbo.RenRenTask AS rrt(NOLOCK)
WHERE   EndTime > GETDATE()
        AND rrt.Status = 1
        AND rrt.id = ${taskId}
  </select>
  <!-- 领取任务时  将任务剩余量-1 茹化肖 2015年9月30日10:56:18 -->
  <update id="cutTaskAvailableCount" parameterType="java.util.HashMap" >
UPDATE dbo.RenRenTask SET AvailableCount=AvailableCount-1
    where Id = #{taskid,jdbcType=BIGINT}
  </update>
    <!-- 取消任务时  将任务剩余量+1 茹化肖 2015年9月30日10:56:18 -->
  <update id="addTaskAvailableCount" parameterType="java.util.HashMap" >
	UPDATE dbo.RenRenTask SET AvailableCount=AvailableCount+1
    where Id = #{taskid,jdbcType=BIGINT}
  </update>
  
    	<!-- 获取任务列表 WHERE茹化肖 2015年11月24日13:51:51 -->
  <sql id="getPagedRenRenTaskListWhere">
		1=1		
		<if test="createTimeBegin != null and createTimeBegin!=''">
			and createTime >=''${createTimeBegin}''
		</if>
		<if test="createTimeEnd != null and createTimeEnd!=''">
			and ''${createTimeEnd} 23:59:59''>createTime
		</if>
	    <if test="beginTime != null and beginTime!=''">
			and endTime>=''${beginTime}''
		</if>
		<if test="endTime != null and endTime!=''">
			and ''${endTime} 23:59:59''>=beginTime
		</if>
	    <if test="status != null and status>-1">
			and status=${status}
		</if>
		<if test="taskType != null and taskType>0">
			and status=${status}
		</if>
		<if test="taskTitle != null and taskTitle!=''">
			and taskTitle like ''%${taskTitle}%''
		</if>	
		<if test="pusher != null and pusher!=''">
			and pusher like ''%${pusher}%''
		</if>	
	</sql>
  	<!-- 获取任务列表 茹化肖 2015年11月24日13:51:51 -->
  	<select id="getPagedRenRenTaskList" resultType="com.renrentui.renrenentity.domain.RenRenTaskModel"
		parameterType="com.renrentui.renrenentity.req.PagedRenRenTaskReq"
		statementType="CALLABLE">
		{call Sp_CustomPage2015_V1(
		' rrt.Id DESC ',
		'id ,
        TaskTitle ,
        CreateName ,
        CreateTime ,
        BeginTime ,
        EndTime ,
        Pusher ,
        Amount ,
        Status ,
        TaskType
        ',
		' dbo.RenRenTask AS rrt (NOLOCK)  
        ',
		'
		<include refid="getPagedRenRenTaskListWhere" />
		',
		#{pageSize,mode=IN,jdbcType=INTEGER},
		#{currentPage,mode=IN,jdbcType=INTEGER}
		,1,
		#{totalRecord,mode=OUT,jdbcType=INTEGER},
		#{totalPage,mode=OUT,jdbcType=INTEGER}
		)}
	</select>
	  <update id="setTaskStatus" parameterType="com.renrentui.renrenentity.req.UpdateStatusReq" >
	UPDATE dbo.RenRenTask 
	<set >
      <if test="status != null" >
       status=#{status,jdbcType=BIGINT},
      </if>
      <if test="userName != null and userName!=''" >
       modifyName=#{userName,jdbcType=NVARCHAR},modifyTime=getdate(),
      </if>
      <if test="status != null and status==1" >
        pusher=#{userName,jdbcType=NVARCHAR},
      </if>
    </set>
     where Id = #{reocrdId,jdbcType=BIGINT} and status=#{oldStatus,jdbcType=BIGINT}
  </update>
<select id="getNewTaskList" resultType="com.renrentui.renrenentity.domain.TaskModel" parameterType="com.renrentui.renrenentity.req.TaskReq" >
select 
<if test="itemsCount != 0" >
	top  ${itemsCount} 
</if>
  a.Id as taskId ,
        a.taskGeneralInfo ,
        a.taskTitle as taskName ,
        a.tasktype,
        a.amount,
        m.logo
  FROM      RenRenTask a WITH(nolock)
            JOIN TaskCityRelation b WITH(nolock) ON a.Id = b.TaskId
            JOIN dbo.Business m WITH(NOLOCK) ON a.BusinessId=m.id
            <if test="userId != 0" >
            LEFT JOIN ClienterTask c WITH(nolock) ON a.id = c.TaskId and c.ClienterId =  ${userId}
  			</if> 
  WHERE     a.Status = 1
  			and getdate()>=a.BeginTime and a.EndTime>getdate()  
            AND (b.CityCode = ${cityCode} or b.CityCode =${provinceCode} or b.CityCode=-1)
		    <if test="userId != 0" >
		   	   AND c.id IS NULL
		   	</if> 
			 <if test="nextId != 0" >
		         and a.Id > ${nextId}
		     </if>
   order by a.Id asc;
  </select>   
  
   <select id="getNewTaskListTotal" resultType="java.lang.Integer" parameterType="com.renrentui.renrenentity.req.TaskReq" >
   	select count(1) 
   	FROM      RenRenTask a WITH(nolock)
            JOIN TaskCityRelation b WITH(nolock) ON a.Id = b.TaskId
            JOIN dbo.Business m WITH(NOLOCK) ON a.BusinessId=m.id
            <if test="userId != 0" >
            LEFT JOIN ClienterTask c WITH(nolock) ON a.id = c.TaskId and c.ClienterId =  ${userId}
  			</if> 
  WHERE     a.Status = 1
  			and getdate()>=a.BeginTime and a.EndTime>getdate()  
            AND (b.CityCode = ${cityCode} or b.CityCode=-1)
		    <if test="userId != 0" >
		   	   AND c.id IS NULL
		   	</if> 
  </select> 
  <!--  我的任务  已领取 -->
  <select id="getMyReceivedTaskList" resultType="com.renrentui.renrenentity.domain.MyReceiveTask" 
  parameterType="com.renrentui.renrenentity.req.TaskReq" >
	select 
	<if test="itemsCount != 0" >
		top  ${itemsCount} 
	</if>
	mt.taskId,
	mt.taskGeneralInfo,
	mt.taskName ,
	mt.tasktype,
	mt.amount,
	mt.logo,
	mb.auditStatus ,
	mb.auditNum,
	CASE mt.TaskType
	  WHEN 1 THEN 0
	  ELSE mt.CompleteNum
	END AS complateNum
	from ( 
		  select 
		        a.Id as taskId ,
		        a.taskGeneralInfo ,
		        a.taskTitle as taskName ,
		        a.tasktype,
		        a.amount,
		        a.status as taskStatus,
		        m.logo,
		        c.id,
		        c.CompleteNum
		  FROM      RenRenTask a WITH(nolock)
		            JOIN dbo.Business m WITH(NOLOCK) ON a.BusinessId=m.id
		            JOIN ClienterTask c WITH(nolock) ON a.id = c.TaskId
		  WHERE     c.ClienterId =  ${userId} 
					<if test="taskStatus == 3" >
					       and  a.status in (3,4)
					</if>
					<if test="taskStatus == 1" >
					       and  a.status =1
					</if>
		  			) mt
	LEFT JOIN ( SELECT CtId,Status as auditStatus ,COUNT(0) AS auditNum FROM TaskDatum WITH(nolock)
	            WHERE     ClienterId =  ${userId} 
	            GROUP BY CtId,Status) mb
	ON mt.id=mb.ctid
	<if test="nextId != 0" >
	       where  mt.taskId > ${nextId}
	</if>
	order by mt.taskId asc;
  </select>   
    <!--  我的任务  已领取 -->
   <select id="getMyReceivedTaskListTotal" resultType="java.lang.Integer" parameterType="com.renrentui.renrenentity.req.TaskReq" >
   	select count(1) from dbo.RenRenTask rt ( nolock )
        left join dbo.[Order] o ( nolock ) on rt.Id = o.TaskId and o.ClienterId = ${userId} 
where o.ClienterId is not null and o.OrderStatus = 0 
 	 <if test="nextId != 0" >
         and o.Id > ${nextId}
     </if>
  </select> 
  <!-- 我的任务  审核中  未通过 -->
   <select id="getSubmittedTaskList" resultType="com.renrentui.renrenentity.domain.TaskModel" parameterType="com.renrentui.renrenentity.req.TaskReq" >
   
   	select 
   	<if test="itemsCount != 0" >
   		top  ${itemsCount} 
   	</if> 
       rt.Id TaskId ,
                rt.TaskGeneralInfo ,
                rt.Pusher ,
                rt.TaskTitle TaskName ,
                rt.Amount ,
                rt.AvailableCount ,
                case  when o.OrderStatus is null then -1 else o.OrderStatus end [Status], o.AuditStatus ,
                isnull(rt.BeginTime,'') BeginTime,
                isnull(rt.EndTime,'') EndTime,
                rt.PaymentMethod ,
                rt.TaskCycle ,
                isnull(o.CreateTime,'') ReceivedTime ,
                isnull(o.FinishTime,'') FinishTime,
                o.Id myReceivedTaskId,
                o.Id orderId,isnull(o.AuditTime,'') AuditTime,
                o.CancelTime,
                o.DealLineTime,
                b.logo,
                (case when rt.EndTime>getdate() and rt.AvailableCount>0 and rt.Status=1 and rt.Id not in (
					 select TaskId from dbo.[Order](nolock) where ClienterId=${userId} and OrderStatus=0
                ) then 1 else 0 end) IsAgainPickUp,
                (SELECT count(1) FROM dbo.[Order] oo(nolock) where oo.TaskId = rt.id
and oo.AuditStatus = 0 AND oo.OrderStatus=1) WaitAuditCount 
from    dbo.[Order] o join dbo.RenRenTask rt on rt.Id = o.TaskId  and o.ClienterId = ${userId}
		join dbo.Business b (nolock) on rt.BusinessId = b.Id 
where  1=1 
      <if test="orderStatus != null" >
       and   o.orderStatus = #{orderStatus,jdbcType=SMALLINT}
      </if>
     <if test="auditStatus != null" >
        and  auditStatus = #{auditStatus,jdbcType=SMALLINT}
      </if>
	  <if test="nextId != 0" >
         and o.Id > ${nextId}
     </if>
order by o.Id asc;
  </select>   
    <!-- 我的任务  审核中  未通过 -->
  <select id="getSubmittedTaskListTotal" resultType="java.lang.Integer" parameterType="com.renrentui.renrenentity.req.TaskReq" >
   	select count(1) from  dbo.[Order] o
                join dbo.RenRenTask rt on rt.Id = o.TaskId and o.ClienterId =  ${userId} where  1=1 
      <if test="orderStatus != null" >
        and  o.orderStatus = #{orderStatus,jdbcType=SMALLINT}  
      </if>
     <if test="auditStatus != null" >
       and auditStatus = #{auditStatus,jdbcType=SMALLINT}
      </if>
     <if test="nextId != 0" >
         and o.Id > ${nextId}
     </if>
  </select> 
  <!-- 超时取消任务服务  add by caoheyang 20151010 -->
	<update id="outTimeCanelTask">
		update dbo.RenRenTask set Status=3
		output inserted.Id,3,'系统服务','超时任务自动过期' into RenRenTasklog (RenRenTaskId,
		OptType,
		OptName,
		Remark)
		where EndTime 
<![CDATA[<]]>
		=GETDATE()
		   and Status=1
	</update>
	  <update id="update" parameterType="com.renrentui.renrenentity.RenRenTask" >
    update RenRenTask
    set TaskTitle = #{taskTitle,jdbcType=NVARCHAR},
      TaskNotice = #{taskNotice,jdbcType=NVARCHAR},
      TaskGeneralInfo = #{taskGeneralInfo,jdbcType=NVARCHAR},
      BusinessId = #{businessId,jdbcType=BIGINT},
      Pusher = #{pusher,jdbcType=NVARCHAR},
      ModifyName = #{modifyName,jdbcType=NVARCHAR},
      ModifyTime = getdate(),
      BeginTime = #{beginTime,jdbcType=TIMESTAMP},
      EndTime = #{endTime,jdbcType=TIMESTAMP},
      TaskCycle = #{taskCycle,jdbcType=DOUBLE},
      AvailableCount = #{availableCount,jdbcType=INTEGER},
      Amount = #{amount,jdbcType=DECIMAL},
      Status = #{status,jdbcType=INTEGER},
      TaskTotalCount = #{taskTotalCount,jdbcType=INTEGER},
      SnapshotTemplateId = #{snapshotTemplateId,jdbcType=BIGINT},
      Link = #{link,jdbcType=NVARCHAR},
      PaymentMethod = #{paymentMethod,jdbcType=SMALLINT},
      AuditCycle=#{auditCycle,jdbcType=INTEGER},
      TaskNote = #{taskNote,jdbcType=NVARCHAR},
      TargetPeople = #{targetPeople,jdbcType=INTEGER},
      CompanySummary= #{companySummary,jdbcType=NVARCHAR}
    where Id = #{id,jdbcType=BIGINT} and (Status=0 or Status=2)
  </update>
     <select id="getListByTemplateId" resultType="com.renrentui.renrenentity.RenRenTask" parameterType="java.lang.Long" >
   SELECT a.* FROM RenRenTask a with(nolock) JOIN 
  dbo.TemplateSnapshot b with(nolock) 
  ON a.SnapshotTemplateId=b.id  
  where  b.TemplateId = #{templateId,jdbcType=BIGINT} and (a.Status=0 or a.Status=2)
  </select> 
 
  <!-- 统计我的任务列表   已领取 审核中 未通过 -的数量信息  add by caoheyang  20151026-->
   <select id="getMyJobCount" resultType="com.renrentui.renrenentity.domain.MyJobTaskDomain" parameterType="com.renrentui.renrenentity.req.TaskReq" >
   select   ISNULL(SUM(CASE when OrderStatus = 0
                                 and AuditStatus = 0 then 1
                            else 0
                       end), 0) ReceivedCount ,
            ISNULL(SUM(CASE when OrderStatus = 1
                                 and AuditStatus = 0 then 1
                            else 0
                       end), 0) PassCount ,
            ISNULL(SUM(CASE when OrderStatus = 1
                                 and AuditStatus = 3 then 1
                            else 0
                       end), 0) NoPassCount
   from     dbo.[Order] o
            join dbo.RenRenTask rt on rt.Id = o.TaskId where  o.ClienterId =  ${userId} 
  </select> 
  <!-- 添加任务的步骤信息 茹化肖 2015年11月16日15:30:04 -->
  <insert id="insertTaskSetp" parameterType="com.renrentui.renrenentity.domain.TaskSetp">
  INSERT INTO dbo.TaskSetp
  (TaskId,
   LinkTitle,
   SortNo,
   SetpType,
   [Content])
   values (
   ${taskId},
   '${linkTitle}',
   ${sortNo} ,
   ${setpType},
   '${content}')
  </insert>
    <!-- 添加任务的模板组信息 茹化肖 2015年11月16日15:30:04 -->
  <insert id="insertTemplateGrpup" parameterType="com.renrentui.renrenentity.domain.TemplateGroup">
  		<selectKey resultType="java.lang.Long" keyProperty="id"
				order="AFTER">
				select @@IDENTITY as id
	    </selectKey>
INSERT INTO dbo.TemplateGroup
        ( TaskId ,
          GroupType ,
          Title
        )
VALUES  ( ${taskId} , 
          ${groupType} , 
          '${title}' 
        )
  </insert>
  <!-- 参与任务 茹化肖 2015年11月19日14:40:41 -->
  <select id="insertClienterTask" parameterType="com.renrentui.renrenentity.domain.ClienterTask" resultType="java.lang.Integer">
  IF NOT EXISTS (SELECT id FROM ClienterTask WHERE TaskId=${taskId} AND ClienterId=${clienterId})
	BEGIN
		INSERT INTO dbo.ClienterTask	
		        ( TaskId ,
		          ClienterId ,
		          BusinessId ,
		          Amount ,
		          TaskType
		        )
		VALUES  ( ${taskId} , 
		          ${clienterId} , 
		          ${businessId} , 
		          ${amount} , 
		          ${taskType} 
		        ); 
	SELECT 1
	END
ELSE
	BEGIN
	SELECT 2
	END
  
  </select>
  <!-- 提交一次资料将完成次数加1 茹化肖2015年11月20日00:16:42 -->
  <update id="addClienterCompleteCount" parameterType="java.lang.Long">
  UPDATE ClienterTask SET CompleteNum=(CompleteNum+1) WHERE id=#{ctId,jdbcType=BIGINT}
  </update>
</mapper>